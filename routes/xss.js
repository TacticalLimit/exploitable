var express = require('express');
var router = express.Router();

const title = 'Cross-Site-Scripting (XSS)';

/* GET XSS page. */
router.get('/', function(req, res, next) {
  const db = req.app.locals.db;
  db.serialize(() => {
    db.all('SELECT * FROM messages ORDER BY message_time DESC', (error, rows) => {
      if (error) {
        console.error(error);
      }
      res.render('xss', { 
        title,
        messages: rows,
        error: req.query.error
      });
    });
  });
});

router.post('/', function(req, res, next) {
  const { from, message } = req.body;
  if (!from || !message || from.length === 0 || message.length === 0) {
    res.redirect('/xss?error=Missing "From" or "Message".');
    return;
  }
  const db = req.app.locals.db;
  const sql = `INSERT INTO messages (message_from, message_time, message) VALUES (:from, :date, :message)`;
  // const sql = `INSERT INTO messages (message_from, message_time, message) VALUES ("${from}", "${new Date().toISOString()}", "${message}")`;
  db.run(sql, { 
    ':from': from,
    ':date': new Date().toISOString(),
    ':message': message
  }, (error) => {
    if (error) {
      console.error(error);
      res.redirect(`/xss?error=${error}`);
      return;
    }
    res.redirect('/xss');
  });
});

module.exports = router;
