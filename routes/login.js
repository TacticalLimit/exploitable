var express = require('express');
var crypto = require('crypto');
var router = express.Router();

/* GET login page. */
router.get('/', function(req, res, next) {
  const error = req.query.error;
  res.render('login-input', {
    title: 'Login',
    error
  });
});

router.post('/', function(req, res, next) {
  const db = req.app.locals.db;
  const { email, password } = req.body;
  const hashedPassword = crypto.createHash('md5').update(req.body.password).digest('hex');
  const sql = `SELECT * FROM users WHERE email="${email}" AND password="${hashedPassword}"`;
  console.log('Using SQL: ', sql);
  db.get(sql, (error, row) => {
    if (error) {
      res.send(`Internal error: ${error}`);
      next(error);
      return;
    }
    if (!row) {
      res.redirect('/login?error=Invalid username or password');
      return;
    }
    console.log(row);
    res.render('login-success', {
      title: `Logged in as ${row.username}`,
      username: row.username,
      email: row.email,
    });
  });
});

module.exports = router;
